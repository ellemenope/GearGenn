<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GearGen — Upgraded Demo</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#071127; --panel:#0f1720; --muted:#9aa6b2; --accent:#00cfff; --accent2:#ff7a3c;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071127 0%, #0b1520 100%); color:#e6eef6;}
  .site{max-width:1200px;margin:28px auto;padding:18px}
  header {display:flex;align-items:center;justify-content:space-between;padding:12px 8px;margin-bottom:18px;}
  .logo {display:flex;align-items:center;gap:10px}
  .logo .mark{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#1b2430,#273240);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.06)}
  .logo strong{font-weight:700;color:#dfe9f5}
  h1{margin:6px 0 0 0;font-size:20px}
  p.lead{color:var(--muted);margin-top:6px;font-size:14px}

  .grid {display:grid; grid-template-columns: 360px 1fr; gap:20px; align-items:start;}
  .card {background:var(--panel); border-radius:12px; padding:14px; box-shadow: 0 6px 22px rgba(2,6,12,0.6); border:1px solid rgba(255,255,255,0.03)}
  .card h3{margin:0 0 8px 0;font-size:14px;color:#f4fbff}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:600}
  input[type=number], input[type=text], select {width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:#e6eef6}
  .row{display:flex;gap:8px}
  .btn {background:linear-gradient(90deg,var(--accent),#2fb8ff);border:none;padding:10px 12px;border-radius:8px;color:#072;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(0,200,255,0.08)}
  .btn.alt{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);box-shadow:none}
  .muted{color:var(--muted);font-size:13px}

  /* mockups row */
  .mockups{display:flex;gap:18px;margin-top:18px;flex-wrap:wrap;justify-content:space-between}
  .mock{width:calc((100% - 36px)/3); background:#ffffff; color:#0c1114; border-radius:10px;padding:10px;text-align:center}
  .mock .frame{height:200px;border-radius:8px;background:#fbfdff;display:flex;align-items:center;justify-content:center;border:1px dashed #e6eef6; overflow:hidden}
  .mock p{font-weight:700;margin:8px 0 0 0}

  /* center area - svg and 3d */
  .stage {display:grid; grid-template-columns: 1fr 480px; gap:18px; margin-top:18px}
  .svgCard, .previewCard {background:var(--panel); border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.03)}
  #svgOut {width:100%; height:420px; background:#fbfdff; border-radius:8px; display:flex;align-items:center;justify-content:center; overflow:auto}
  #preview3d {width:100%; height:420px; border-radius:8px; overflow:hidden;background:linear-gradient(180deg,#111317,#0b0d10)}

  /* outputs table */
  .outputs{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px}
  .out{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:10px;border-radius:8px;font-weight:600; color:#dff4ff}
  .small{font-size:12px;color:var(--muted);font-weight:500}

  /* compare area */
  .compare{margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* responsive */
  @media (max-width:1000px){
    .grid{grid-template-columns: 1fr; }
    .stage{grid-template-columns:1fr}
    .mock{width:100%}
  }
</style>
</head>
<body>
  <div class="site">
    <header>
      <div class="logo"><div class="mark">G</div><div><strong>GearGen</strong><div class="muted" style="font-size:12px">Auto gear design • students & shops</div></div></div>
      <nav class="muted" style="display:flex;gap:14px;align-items:center">
        <a href="#" class="muted">Features</a>
        <a href="#" class="muted">Demo</a>
        <a href="#" class="muted">Team</a>
        <a href="#" class="muted">Contact</a>
      </nav>
    </header>

    <div>
      <h1>Design accurate spur gears instantly — demo</h1>
      <p class="lead">Enter torque, RPM, ratio and module. GearGen calculates geometry, generates a 2D CAD SVG and a 3D model you can inspect, download, or export.</p>
    </div>

    <div class="grid">
      <!-- left: controls -->
      <div class="card">
        <h3>Controls</h3>

        <label>Torque (N·m)</label><input id="torque" type="number" value="100" min="0">
        <label>RPM</label><input id="rpm" type="number" value="1500" min="0">
        <label>Gear ratio (z2 : z1)</label><input id="ratio" type="text" value="3:1">
        <label>Module (mm)</label><input id="module" type="number" value="2" step="0.1" min="0.2">
        <label>Teeth on pinion (z1) — optional</label><input id="z1" type="number" placeholder="Auto">

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="gen" class="btn">Generate</button>
          <button id="compareToggle" class="btn alt">Toggle Compare</button>
        </div>

        <div class="compare" id="compareControls" style="display:none">
          <div style="flex:1">
            <label>Second gear teeth (z1b) - optional</label>
            <input id="z2b" type="number" placeholder="Auto">
          </div>
          <div style="flex:1">
            <label>Second gear module (mm)</label>
            <input id="moduleB" type="number" value="2" step="0.1">
          </div>
        </div>

        <div class="outputs">
          <div class="out">Pitch Dia (PD): <div id="pd" style="float:right">-</div></div>
          <div class="out">Outside Dia (OD): <div id="od" style="float:right">-</div></div>
          <div class="out small">Center Dist (mm): <div id="center" style="float:right">-</div></div>
          <div class="out small">Tangential Force (N): <div id="tforce" style="float:right">-</div></div>
        </div>

        <div style="margin-top:12px">
          <button id="dlSvg" class="btn alt">Download SVG</button>
          <button id="dlPng" class="btn alt">Download 3D PNG</button>
          <button id="dlObj" class="btn alt">Export OBJ</button>
        </div>

        <p class="small" style="margin-top:10px">Notes: OBJ is a simple mesh export for demo use only. STL export can be added on request.</p>
      </div>

      <!-- right: stage -->
      <div>
        <div class="stage">
          <div class="svgCard card">
            <h3>Generated 2D CAD</h3>
            <div id="svgOut" role="img" aria-label="Generated gear CAD">
              <!-- svg will go here -->
            </div>
            <div style="margin-top:10px" class="small">SVG includes PD annotation and teeth count. Right-click to save or use Download SVG.</div>
          </div>

          <div class="previewCard card">
            <h3>3D Preview</h3>
            <div id="preview3d"></div>
            <div style="margin-top:10px;display:flex;gap:8px;justify-content:space-between">
              <div class="small">Use mouse to rotate / zoom</div>
              <div><button id="spinBtn" class="btn alt">Toggle Spin</button></div>
            </div>
          </div>
        </div>

        <!-- demo mockups -->
        <div class="mockups" aria-hidden="true" style="margin-top:16px">
          <div class="mock"><div class="frame"> <img src="" id="m1" style="max-width:100%; height:100%; object-fit:contain" alt=""> </div><p>Mockup 1: Input UI</p></div>
          <div class="mock"><div class="frame" id="m2frame"> SVG CAD </div><p>Mockup 2: CAD Drawing</p></div>
          <div class="mock"><div class="frame" id="m3frame"> 3D Preview </div><p>Mockup 3: 3D Model</p></div>
        </div>
      </div>
    </div>
  </div>

<!-- libraries -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

<script>
/* ---------- gear math & utilities ---------- */

function parseRatio(r){ r = (''+r).trim(); if(r.includes(':')){const [a,b]=r.split(':').map(Number); if(!isNaN(a)&&!isNaN(b)&&b) return a/b;} const n=Number(r); return isNaN(n)||n===0?2:n; }
function chooseZ1(ratio){ for(let c=12;c<=60;c++){ const z2=Math.round(c*ratio); if(Math.abs(z2/c - ratio) < 1e-9) return c; } return 20; }

function compute(params){
  let torque = Number(params.torque)||0;
  let rpm = Number(params.rpm)||0;
  let ratio = parseRatio(params.ratio);
  let module = Number(params.module)||2;
  let z1 = params.z1 ? Math.max(8, Math.round(Number(params.z1))) : null;
  if(!z1) z1 = chooseZ1(ratio);
  let z2 = Math.max(8, Math.round(z1 * ratio));
  const pd2 = (z2 * module); // pitch diameter gear2
  const pd1 = (z1 * module);
  const od2 = pd2 + 2*module;
  const center = (pd1 + pd2)/2;
  // simple tangential force (Nm -> N at pitch radius): F = T / r  (r = PD/2 in mm -> convert to m)
  const r_m = (pd2/2)/1000;
  const tforce = r_m>0 ? (torque / r_m) : 0;
  return { torque, rpm, ratio, module, z1, z2, pd1:pd1.toFixed(2), pd2:pd2.toFixed(2), od2:od2.toFixed(2), center:center.toFixed(2), tforce:Math.round(tforce) };
}

/* ---------- involute-like gear contour generator (approx) ---------- */
/* This function creates a polygonal approximation of an involute-like tooth using parametric math.
   It produces points for the gear outer contour suitable for SVG and Three.js shape extrusion.
*/
function involutePoints(teeth, module, pressureAngleDeg=20, steps=8){
  const pressure = pressureAngleDeg * Math.PI/180;
  const pd = teeth * module;
  const R = pd/2; // pitch radius mm
  const addendum = module;
  const dedendum = 1.25 * module;
  const outer = R + addendum;
  const root = R - dedendum;
  const baseR = R * Math.cos(pressure);
  const points = [];
  // approximate single tooth profile and revolve
  const toothAngle = 2*Math.PI/teeth;
  for(let i=0;i<teeth;i++){
    const centerAng = i * toothAngle;
    // sample along outer arc for tooth area
    const half = toothAngle * 0.35;
    const angStart = centerAng - half;
    const angEnd = centerAng + half;
    for(let s=0;s<steps;s++){
      const t = s/(steps-1);
      const ang = angStart + (angEnd-angStart)*t;
      const radius = (t<0.5) ? (root + (R-root)*(t*2)) : (R + (outer-R)*((t-0.5)*2));
      const x = radius * Math.cos(ang);
      const y = radius * Math.sin(ang);
      points.push([x,y]);
    }
  }
  return {points, pd, outer, root, baseR};
}

/* ---------- SVG generator (engineering annotations) ---------- */
function makeSVG(teeth, module){
  const {points, pd, outer, root, baseR} = involutePoints(teeth, module, 20, 10);
  // compute bounding
  const scale = 2.2; // visual scaling
  // create svg element via DOM
  const svgns = "http://www.w3.org/2000/svg";
  const size = Math.max(600, outer*scale*2 + 120);
  const svg = document.createElementNS(svgns,'svg');
  svg.setAttribute('viewBox', `${-size/2} ${-size/2} ${size} ${size}`);
  svg.setAttribute('width','100%'); svg.setAttribute('height','100%');

  // background / grid lightly
  const bg = document.createElementNS(svgns,'rect'); bg.setAttribute('x',-size/2); bg.setAttribute('y',-size/2); bg.setAttribute('width',size); bg.setAttribute('height',size); bg.setAttribute('fill','#fbfdff'); svg.appendChild(bg);

  // group for gear
  const g = document.createElementNS(svgns,'g');
  g.setAttribute('transform','translate(0,0)');

  // polygon path
  let d = '';
  for(let i=0;i<points.length;i++){
    const p = points[i];
    const x = p[0]*scale, y = p[1]*scale;
    d += (i===0? 'M ':'L ') + x + ' ' + y + ' ';
  }
  d += 'Z';
  const path = document.createElementNS(svgns,'path');
  path.setAttribute('d', d);
  path.setAttribute('fill','#e9f2f6');
  path.setAttribute('stroke','#2b3338');
  path.setAttribute('stroke-width','1');
  g.appendChild(path);

  // center hub
  const hub = document.createElementNS(svgns,'circle');
  hub.setAttribute('cx',0); hub.setAttribute('cy',0); hub.setAttribute('r', Math.max(8,module*2)*scale); hub.setAttribute('fill','#ffffff'); hub.setAttribute('stroke','#0f1113'); g.appendChild(hub);

  // annotation PD circle
  const pdCircle = document.createElementNS(svgns,'circle'); pdCircle.setAttribute('cx',0); pdCircle.setAttribute('cy',0); pdCircle.setAttribute('r', (pd/2)*scale); pdCircle.setAttribute('fill','none'); pdCircle.setAttribute('stroke','#b0c9d6'); pdCircle.setAttribute('stroke-width','1'); pdCircle.setAttribute('stroke-dasharray','6 4'); g.appendChild(pdCircle);

  // label
  const txt = document.createElementNS(svgns,'text'); txt.setAttribute('x', -size/2+18); txt.setAttribute('y', -size/2+26); txt.setAttribute('font-size','14'); txt.setAttribute('fill','#223'); txt.textContent = `Teeth: ${teeth} • Module: ${module} mm • PD: ${pd.toFixed(2)} mm`;
  svg.appendChild(g);
  svg.appendChild(txt);
  return svg;
}

/* ---------- Three.js 3D build ---------- */
let renderer,scene,camera,controls,gearMesh, spinning=false;
function init3D(container){
  container.innerHTML='';
  renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  container.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 5000);
  camera.position.set(0, 220, 420);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // lights
  scene.add(new THREE.HemisphereLight(0xffffff, 0x0a0a0a, 0.5));
  const d = new THREE.DirectionalLight(0xffffff, 0.9); d.position.set(200,300,200); scene.add(d);
  const d2 = new THREE.DirectionalLight(0xffffff, 0.35); d2.position.set(-200,-100,200); scene.add(d2);

  animate();
  window.addEventListener('resize', ()=> {
    renderer.setSize(container.clientWidth, container.clientHeight);
    camera.aspect = container.clientWidth/container.clientHeight; camera.updateProjectionMatrix();
  });
}
function animate(){
  requestAnimationFrame(animate);
  if(spinning && gearMesh) gearMesh.rotation.z += 0.006;
  controls.update();
  renderer.render(scene, camera);
}

function buildGearMesh(teeth,module, thickness=20, bore=10){
  // build shape from involutePoints polygon
  const {points, pd, outer} = involutePoints(teeth,module,20,10);
  const scale = 2.5;
  const shape = new THREE.Shape();
  const pts = points.map(p=> new THREE.Vector2(p[0]*scale, p[1]*scale));
  if(pts.length>0){
    shape.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length;i++) shape.lineTo(pts[i].x, pts[i].y);
    shape.closePath();
  }
  // create hole
  const hole = new THREE.Path(); const holeR = Math.max(6,bore)*scale;
  const segs=32;
  for(let i=0;i<segs;i++){ const a = (i/segs)*Math.PI*2; const x = Math.cos(a)*holeR, y = Math.sin(a)*holeR; if(i===0) hole.moveTo(x,y); else hole.lineTo(x,y);}
  hole.closePath(); shape.holes.push(hole);

  const extrude= new THREE.ExtrudeGeometry(shape, {depth:thickness, bevelEnabled:true, bevelThickness:1, bevelSize:1.2, bevelSegments:3});
  extrude.computeVertexNormals();
  extrude.center();

  const mat = new THREE.MeshStandardMaterial({color:0xbfc8cf, metalness:0.92, roughness:0.25});
  const mesh = new THREE.Mesh(extrude, mat);
  mesh.rotation.x = -Math.PI/2;
  return mesh;
}

/* ---------- UI wiring ---------- */
const genBtn = document.getElementById('gen');
const torqueEl = document.getElementById('torque');
const rpmEl = document.getElementById('rpm');
const ratioEl = document.getElementById('ratio');
const moduleEl = document.getElementById('module');
const z1El = document.getElementById('z1');
const pdEl = document.getElementById('pd');
const odEl = document.getElementById('od');
const centerEl = document.getElementById('center');
const tforceEl = document.getElementById('tforce');
const svgOut = document.getElementById('svgOut');
const preview3d = document.getElementById('preview3d');
const dlSvgBtn = document.getElementById('dlSvg');
const dlPngBtn = document.getElementById('dlPng');
const dlObjBtn = document.getElementById('dlObj');
const compareToggle = document.getElementById('compareToggle');
const compareControls = document.getElementById('compareControls');
const z2bEl = document.getElementById('z2b');
const moduleBEl = document.getElementById('moduleB');
const spinBtn = document.getElementById('spinBtn');

init3D(preview3d);

function clearScene(){
  if(gearMesh){ scene.remove(gearMesh); gearMesh.geometry.dispose(); gearMesh.material.dispose(); gearMesh=null; }
}

function renderAll(){
  const params = { torque:torqueEl.value, rpm:rpmEl.value, ratio:ratioEl.value, module:moduleEl.value, z1:z1El.value };
  const res = compute(params);

  // update outputs
  pdEl.textContent = res.pd2 + ' mm';
  odEl.textContent = res.od2 + ' mm';
  centerEl.textContent = res.center + ' mm';
  tforceEl.textContent = (res.tforce>0? res.tforce:'-') ;

  // generate svg
  const svg = makeSVG(res.z2, res.module);
  svgOut.innerHTML = '';
  svgOut.appendChild(svg);

  // update mock frame images (quick visual)
  document.getElementById('m2frame').textContent = ''; document.getElementById('m2frame').appendChild(svg.cloneNode(true));

  // 3D model
  clearScene();
  gearMesh = buildGearMesh(res.z2, res.module, 18, 10);
  scene.add(gearMesh);

  // center camera
  const box = new THREE.Box3().setFromObject(gearMesh); const size = box.getSize(new THREE.Vector3()).length(); const c = box.getCenter(new THREE.Vector3());
  controls.target.copy(c); camera.position.set(c.x, c.y + Math.max(size*0.5, 120), c.z + Math.max(size*0.9, 240));
  camera.updateProjectionMatrix();

  // set m3 frame placeholder
  document.getElementById('m3frame').textContent = '';
  const mini = renderer.domElement.cloneNode(true); mini.style.width='100%'; mini.style.height='100%'; document.getElementById('m3frame').appendChild(mini);
}

// initial render
renderAll();

// events
genBtn.addEventListener('click', renderAll);
compareToggle.addEventListener('click', ()=> {
  compareControls.style.display = compareControls.style.display === 'none' ? 'flex' : 'none';
});

// download svg
dlSvgBtn.addEventListener('click', ()=> {
  const svgEl = svgOut.querySelector('svg');
  if(!svgEl) return alert('No SVG');
  const s = new XMLSerializer().serializeToString(svgEl);
  const blob = new Blob([s], {type:'image/svg+xml'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='gear_cad.svg'; a.click(); URL.revokeObjectURL(url);
});

// download PNG of 3d canvas
dlPngBtn.addEventListener('click', ()=> {
  renderer.render(scene, camera);
  const url = renderer.domElement.toDataURL('image/png');
  const a = document.createElement('a'); a.href=url; a.download='gear_preview.png'; a.click();
});

// OBJ exporter (basic)
dlObjBtn.addEventListener('click', ()=> {
  if(!gearMesh) return alert('No gear mesh');
  const geom = gearMesh.geometry;
  geom.computeVertexNormals();
  let out = '';
  const pos = geom.attributes.position.array;
  for(let i=0;i<pos.length;i+=3) out += `v ${pos[i]} ${pos[i+1]} ${pos[i+2]}\n`;
  const idx = geom.index ? geom.index.array : null;
  if(idx){
    for(let i=0;i<idx.length;i+=3) out += `f ${idx[i]+1} ${idx[i+1]+1} ${idx[i+2]+1}\n`;
  } else {
    for(let i=0;i<pos.length/3;i+=3) out += `f ${i+1} ${i+2} ${i+3}\n`;
  }
  const blob = new Blob([out], {type:'text/plain'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='gear.obj'; a.click(); URL.revokeObjectURL(url);
});

spinBtn.addEventListener('click', ()=> { spinning = !spinning; spinBtn.textContent = spinning ? 'Stop Spin' : 'Toggle Spin'; });

// quick keyboard: G to generate
window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase() === 'g') renderAll() });

</script>
</body>
</html>
